import sys
import os
import fnmatch
import re
import stat

VERSION = "0.1"

def pmsg(msg, code = 'info'):
    class bcolors:
        HEADER = '\033[95m'
        OKBLUE = '\033[94m'
        OKGREEN = '\033[92m'
        WARNING = '\033[93m'
        FAIL = '\033[91m'
        ENDC = '\033[0m'
        BOLD = '\033[1m'
        UNDERLINE = '\033[4m'
    colorcode = bcolors.OKGREEN
    if code == 'warning':
        colorcode = bcolors.WARNING
    if code == 'error':
        colorcode = bcolors.FAIL
    print bcolors.OKBLUE + bcolors.UNDERLINE + ">>" + bcolors.ENDC + " " + colorcode + msg + bcolors.ENDC

def WPScan(WordpressPath):
    pmsg("Scanning: " + WordpressPath)

    totalInfected = 0

    # Scan for '.php.suspected' files
    pmsg("Scanning for '.php.suspected' files...")
    php_suspected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.php.suspected'):
            php_suspected_matches.append(os.path.join(root, filename))
            totalInfected += 1

    for filename in php_suspected_matches:
        pmsg("Infected '.php.suspected' file found: "+filename, "warning")

    # Scan for infected javascript files
    pmsg("Scanning for infected javascript files...")
    javascript_infected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.js'):
            javascriptFile = os.path.join(root, filename)
            fileHandle = open(javascriptFile, 'r')
            fileData = fileHandle.read()
            infected = False
            if re.search("eval\(eval\('String.fromCharCode", fileData, re.IGNORECASE):
                infected = True
            if re.search("eval\(decodeURIComponent", fileData, re.IGNORECASE):
                infected = True
            if infected:
                javascript_infected_matches.append(os.path.join(root, filename))
                totalInfected += 1

    for filename in javascript_infected_matches:
        pmsg("Infected javscript file found: "+filename, "warning")

    # Scan for infected php files
    pmsg("Scanning for infected php files...")
    php_infected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.php'):
            javascriptFile = os.path.join(root, filename)
            fileHandle = open(javascriptFile, 'r')
            fileData = fileHandle.read()
            infected = False

            if re.search("eval\(", fileData, re.IGNORECASE):
                regexp = re.compile(r'\$GLOBALS.*\\x')
                if regexp.findall(fileData, re.IGNORECASE):
                    infected = True

            regexp = re.compile(r'function.*for.*strlen.*isset')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'\$_POST\[\'cmd\'\]=\"uname -ar ; pwd ; id ; ls -la ;\";')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'foreach\(array\(36,112,61,64,36,95,80,79,83,84,91,39')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'sprintf\(\(substr\(urlencode\(print_r\(array\(\),1\)\)')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'\$s_func="cr"\."eat"\."e_fun"\."cti"\."on";')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'\@\$b374k')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'eval\(base64_decode\("')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'\$_F=__FILE__;\$_X=')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'wget http\:\/\/packetstormsecurity\.org')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'c999sh_surl')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'I just want to be the best defacer')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'buasueu64_duecuoudue')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'wcwrwewawtew_wfwunwction')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'bqaqseq64q_dqeqcqodqe')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'zczrzeatzez_fzuznzcztzizozn')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            regexp = re.compile(r'x_superfetch\(\$a\[1\],\$a\[2\],\$a\[3\],\$a\[4\]\);')
            if regexp.findall(fileData, re.IGNORECASE):
                infected = True

            if infected:
                php_infected_matches.append(os.path.join(root, filename))
                totalInfected += 1

    for filename in php_infected_matches:
        pmsg("Infected php file found: "+filename, "warning")

    # Scan for checksum discrepencies

    # Scan for insecure permissions
    pmsg("Scanning for insecure permissions...")
    folders = [x[0] for x in os.walk(WordpressPath)]
    for folder in folders:
        if os.path.isdir(folder):
            mode = oct(stat.S_IMODE(os.stat(folder).st_mode))
            mode = str(mode)
            if mode.endswith('7'):
                pmsg("Insecure permission ("+str(mode)+") found on: "+folder, "warning")

    colorcode = "info"
    if totalInfected > 0:
        colorcode = "error"
    pmsg("Scan completed. Found "+str(totalInfected)+" infected files.", colorcode)

if len(sys.argv) == 2:
    pmsg("Wordpress Malware Scanner v"+VERSION)
    WordpressPath = sys.argv[1]
    if os.path.isdir(WordpressPath):
        WPScan(WordpressPath)
    else:
        pmsg("Unable to find Wordpress installation  folder ("+WordpressPath+"). Please check path.", "error")
else:
    pmsg("Usage: wms_scan /path/to/wordpress/installations")
