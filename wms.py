import sys
import os
import fnmatch

def pmsg(msg, code = 'info'):
    class bcolors:
        HEADER = '\033[95m'
        OKBLUE = '\033[94m'
        OKGREEN = '\033[92m'
        WARNING = '\033[93m'
        FAIL = '\033[91m'
        ENDC = '\033[0m'
        BOLD = '\033[1m'
        UNDERLINE = '\033[4m'
    colorcode = bcolors.OKGREEN
    if code == 'warning':
        colorcode = bcolors.WARNING
    if code == 'error':
        colorcode = bcolors.FAIL
    print bcolors.OKBLUE + bcolors.UNDERLINE + ">>" + bcolors.ENDC + " " + colorcode + msg + bcolors.ENDC

def WPScan(WordpressPath):
    pmsg("Scanning: " + WordpressPath)

    totalInfected = 0

    # Scan for '.php.suspected' files
    pmsg("Scanning for '*.php.suspected' files...")
    php_suspected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.php.suspected'):
            php_suspected_matches.append(os.path.join(root, filename))
            totalInfected += 1

    for filename in php_suspected_matches:
        pmsg("Infected file found: "+filename, "warning")

    # Scan for infected javascript files
    pmsg("Scanning for infected javascript files...")
    javascript_suspected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.js'):
            javascriptFile = os.path.join(root, filename)
            fileHandle = open(javascriptFile, 'r')
            fileData = fileHandle.read()
            if fileData.find("eval(eval('String.fromCharCode") > -1:
                javascript_suspected_matches.append(os.path.join(root, filename))

    for filename in javascript_suspected_matches:
        pmsg("Infected file found: "+filename, "warning")

    # Scan for infected php files
    pmsg("Scanning for infected php files...")

    colorcode = "info"
    if totalInfected > 0:
        colorcode = "error"
    pmsg("Scan completed. Found "+str(totalInfected)+" infected files.", colorcode)

if len(sys.argv) == 2:
    pmsg("Loading Wordpress Malware Scanner...")
    WordpressPath = sys.argv[1]
    if os.path.isdir(WordpressPath):
        WPScan(WordpressPath)
    else:
        pmsg("Unable to find Wordpress installation  folder ("+WordpressPath+"). Please check path.", "error")
else:
    pmsg("Usage: wms_scan /path/to/wordpress/installations")
