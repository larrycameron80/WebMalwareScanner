import sys
import os
import fnmatch
import re
import stat

def pmsg(msg, code = 'info'):
    class bcolors:
        HEADER = '\033[95m'
        OKBLUE = '\033[94m'
        OKGREEN = '\033[92m'
        WARNING = '\033[93m'
        FAIL = '\033[91m'
        ENDC = '\033[0m'
        BOLD = '\033[1m'
        UNDERLINE = '\033[4m'
    colorcode = bcolors.OKGREEN
    if code == 'warning':
        colorcode = bcolors.WARNING
    if code == 'error':
        colorcode = bcolors.FAIL
    print bcolors.OKBLUE + bcolors.UNDERLINE + ">>" + bcolors.ENDC + " " + colorcode + msg + bcolors.ENDC

def WPScan(WordpressPath):
    pmsg("Scanning: " + WordpressPath)

    totalInfected = 0

    # Scan for '.php.suspected' files
    pmsg("Scanning for '.php.suspected' files...")
    php_suspected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.php.suspected'):
            php_suspected_matches.append(os.path.join(root, filename))
            totalInfected += 1

    for filename in php_suspected_matches:
        pmsg("Infected '.php.suspected' file found: "+filename, "warning")

    # Scan for infected javascript files
    pmsg("Scanning for infected javascript files...")
    javascript_infected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.js'):
            javascriptFile = os.path.join(root, filename)
            fileHandle = open(javascriptFile, 'r')
            fileData = fileHandle.read()
            if re.search("eval\(eval\('String.fromCharCode", fileData, re.IGNORECASE):
                javascript_infected_matches.append(os.path.join(root, filename))

    for filename in javascript_infected_matches:
        pmsg("Infected javscript file found: "+filename, "warning")

    # Scan for infected php files
    pmsg("Scanning for infected php files...")
    php_infected_matches = []
    for root, dirnames, filenames in os.walk(WordpressPath):
        for filename in fnmatch.filter(filenames, '*.php'):
            javascriptFile = os.path.join(root, filename)
            fileHandle = open(javascriptFile, 'r')
            fileData = fileHandle.read()
            if re.search("eval\(", fileData, re.IGNORECASE):
                php_infected_matches.append(os.path.join(root, filename))

    for filename in php_infected_matches:
        pmsg("Infected php file found: "+filename, "warning")


    # Scan for '.php' files in /uploads/ folders

    # Scan for checksum discrepencies

    # Scan for insecure permissions
    pmsg("Scanning for insecure permissions...")
    insecure_folders_matches = []
    folders = [x[0] for x in os.walk(WordpressPath)]
    for folder in folders:
        if os.path.isdir(folder):
            mode = oct(stat.S_IMODE(os.stat(folder).st_mode))
            if mode == '0777':
                insecure_folders_matches.append(folder)

    for folder in insecure_folders_matches:
        pmsg("Insecure permission (777) found on: "+folder, "warning")

    colorcode = "info"
    if totalInfected > 0:
        colorcode = "error"
    pmsg("Scan completed. Found "+str(totalInfected)+" infected files.", colorcode)

if len(sys.argv) == 2:
    pmsg("Loading Wordpress Malware Scanner...")
    WordpressPath = sys.argv[1]
    if os.path.isdir(WordpressPath):
        WPScan(WordpressPath)
    else:
        pmsg("Unable to find Wordpress installation  folder ("+WordpressPath+"). Please check path.", "error")
else:
    pmsg("Usage: wms_scan /path/to/wordpress/installations")
