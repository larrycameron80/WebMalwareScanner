
var LocalScanSelectedPath = false;

function setValue(key, value) {
  window.localStorage.setItem(key, value);
}

function getValue(key) {
  return window.localStorage.getItem(key);
}

function setProgress(value, action) {
  $('.progress-bar').css('width', value+'%').attr('aria-valuenow', value);
  $('#LoadingAction').html(action);

  if (value == 100) {
    $("#LoadingArea").fadeOut(1500);
    window.setTimeout(function() {

      WMSCoreNavigate('main');
      WMSCoreMaximize();
    }, 1000);
  }
}

function setProgressScan(value) {
  $('#scanprogressbar').css('width', value+'%').attr('aria-valuenow', value);
}

function updateLocalFileTree(jsTreeData) {
  jsTreeData = JSON.parse(atob(jsTreeData))
  $('#jstreeLocalFiles').jstree('destroy');
  $('#jstreeLocalFiles')
  .on('changed.jstree', function( e, data ) {
    LocalScanSelectedPath = data.instance.get_path(data.node,'\\');
    WMSCoreListLocalFiles(LocalScanSelectedPath);
  })
  .jstree({"core": jsTreeData });
}

function StartLocalScan() {
  WMSCoreStartLocalScan(LocalScanSelectedPath);
}

function StartRemoteScan() {
  var path = $('#path').val();
  var hostname = $('#hostname').val();
  var port = $('#port').val();
  var username = $('#username').val();
  var password = $('#password').val();
  WMSCoreStartRemoteScan(path, hostname, port, username, password);
}

function ViewScan(id_scan) {
  setValue('id_scan', id_scan);
  WMSCoreNavigate('viewscan');
}

function UpdateScanResults(scanresults) {
  scanresults = JSON.parse(atob(scanresults));

  $('#ScanResults').html('');
  for ( index in scanresults ) {

    var row = '<tr> \
      <td>'+scanresults[index].filename+'</td> \
    </tr>';

    $('#ScanResults').append(row);
  }
}

function UpdateScanDetails(scandetails) {
  scandetails = JSON.parse(atob(scandetails));
  $('#scanStatus').html(scandetails.status);
  $('#scanPath').html(scandetails.path);
  $('#scanType').html(scandetails.type);
  if (scandetails.status == 'PENDING' || scandetails.status == 'PAUSED') {
    $('#panelHeader').removeClass('panel-primary');
    $('#panelHeader').removeClass('panel-success');
    $('#panelHeader').addClass('panel-info');
  }
  if (scandetails.status == 'DONE') {
    $('#scanProgressBarContainer').hide();
    $('#panelHeader').removeClass('panel-info');
    $('#panelHeader').removeClass('panel-success');
    $('#panelHeader').addClass('panel-primary');
    $('#scanResults').show();
  }
  if (scandetails.status == 'ACTIVE') {
    $('#panelHeader').removeClass('panel-primary');
    $('#panelHeader').removeClass('panel-info');
    $('#panelHeader').addClass('panel-success');
  }
  if (scandetails.type == 'remote') {
    $('#scanHostname').html(scandetails.hostname);
    $('#scanPort').html(scandetails.port);
    $('#scanUsername').html(scandetails.username);
    $('#scanPassword').html(scandetails.password);
    $('#ifRemote').show();
  } else {
    if (scandetails.status == 'ACTIVE') {
      $('#scanProgressBarContainer').show();
    }
  }
  if (scandetails.status == 'DONE') {
    if (scandetails.infectedfound == 'yes') {
      $('#scanAlert').html('<div class="alert alert-dismissible alert-warning"> \
        <button type="button" class="close" data-dismiss="alert">&times;</button> \
        <h4>Warning!</h4> \
        <p>The scan found infected files!</p> \
        </div>');
    }
    if (scandetails.infectedfound == 'no') {
      $('#scanAlert').html('<div class="alert alert-dismissible alert-success"> \
        <button type="button" class="close" data-dismiss="alert">&times;</button> \
        <h4>Looking good!</h4> \
        <p>The scan did not find infected files!</p> \
        </div>');
    }
  }
}

function UpdateScanList(scans) {
  scans = JSON.parse(atob(scans))
  $('#ScanList').html('');
  for ( index in scans ) {
    var rowClass = '';

    if (scans[index].status == 'PENDING') {
      rowClass = 'info';
    }

    if (scans[index].status == 'ACTIVE') {
      rowClass = 'success';
    }

    var path = scans[index].path
    if (scans[index].type == 'remote') {
      path = scans[index].username + '@' + scans[index].hostname + ':' + scans[index].path;
    }
    var row = '<tr class="'+rowClass+'"> \
      <td>'+scans[index].scandate+'</td> \
      <td>'+scans[index].status+'</td> \
      <td>'+scans[index].type+'</td> \
      <td>'+path+'</td> \
      <td class="text-right"><button class="btn btn-xs btn-default" onclick="ViewScan(\''+scans[index].id_scan+'\')"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> View</button></td> \
    </tr>';

    $('#ScanList').append(row);
  }
}
